<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Locations - HRMS</title>
    <link rel="stylesheet" th:href="@{/css/table.css}" href="/css/table.css">
</head>
<body>
    <div class="particles">
        <div class="particle" style="width: 120px; height: 120px; left: 10%; top: 20%; animation-delay: 0s;"></div>
        <div class="particle" style="width: 100px; height: 100px; left: 80%; top: 30%; animation-delay: 3s;"></div>
        <div class="particle" style="width: 150px; height: 150px; left: 50%; top: 50%; animation-delay: 6s;"></div>
        <div class="particle" style="width: 90px; height: 90px; left: 20%; top: 70%; animation-delay: 2s;"></div>
        <div class="particle" style="width: 110px; height: 110px; left: 70%; top: 60%; animation-delay: 4s;"></div>
    </div>

    <div class="container">
        <header>
            <h1>Locations</h1>
        </header>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="üîç Search by city, country, or address...">
            </div>
            <a href="/" class="back-button">‚Üê Back to Home</a>
        </div>

        <div class="table-container">
            <table id="location-table">
                <thead>
                    <tr>
                        <th>City</th>
                        <th>Country</th>
                        <th>Street Address</th>
                        <th>Postal Code</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="pagination" id="pagination"></div>
    </div>

    <script th:inline="javascript">
        let apiBaseUrl = /*[[${@environment.getProperty('app.api.base-url')}]]*/ 'http://localhost:9090';
        let allLocations = [];
        let filteredLocations = [];
        let currentPage = 1;
        const itemsPerPage = 20;

        // Fetch locations
        fetch(`${apiBaseUrl}/satya/locations`)
            .then(response => response.json())
            .then(data => {
                allLocations = data;
                filteredLocations = data;
                renderTable();
                renderPagination();
            })
            .catch(error => {
                console.error('Error:', error);
                document.querySelector('#location-table tbody').innerHTML =
                    '<tr><td colspan="4" class="no-data">Error loading locations.</td></tr>';
            });

        // Search
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filteredLocations = allLocations.filter(loc => {
                const city = (loc.city || '').toLowerCase();
                const country = (loc.countryName || '').toLowerCase();
                const address = (loc.streetAddress || '').toLowerCase();
                const postal = (loc.postalCode || '').toLowerCase();
                return city.includes(searchTerm) || country.includes(searchTerm) || address.includes(searchTerm) || postal.includes(searchTerm);
            });
            currentPage = 1;
            renderTable();
            renderPagination();
        });

        function renderTable() {
            const tbody = document.querySelector('#location-table tbody');
            tbody.innerHTML = '';

            if (filteredLocations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">No locations found.</td></tr>';
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageLocations = filteredLocations.slice(start, end);

            pageLocations.forEach(loc => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${loc.city || 'N/A'}</td>
                    <td>${loc.countryName || 'N/A'}</td>
                    <td>${loc.streetAddress || 'N/A'}</td>
                    <td>${loc.postalCode || 'N/A'}</td>
                `;

                // Entire row clickable
                row.onclick = () => window.location.href = `/employees?locationId=${loc.id}`;
                tbody.appendChild(row);
            });
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (filteredLocations.length <= itemsPerPage) return;

            const totalPages = Math.ceil(filteredLocations.length / itemsPerPage);

            // Prev
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‚Äπ';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { currentPage--; renderTable(); renderPagination(); };
            pagination.appendChild(prevBtn);

            // Pages
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = i === currentPage ? 'active' : '';
                btn.onclick = () => { currentPage = i; renderTable(); renderPagination(); };
                pagination.appendChild(btn);
            }

            // Next
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '‚Ä∫';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { currentPage++; renderTable(); renderPagination(); };
            pagination.appendChild(nextBtn);

            // Info
            const info = document.createElement('div');
            info.className = 'pagination-info';
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(currentPage * itemsPerPage, filteredLocations.length);
            info.textContent = `Showing ${start}-${end} of ${filteredLocations.length}`;
            pagination.appendChild(info);
        }
    </script>
</body>
</html>